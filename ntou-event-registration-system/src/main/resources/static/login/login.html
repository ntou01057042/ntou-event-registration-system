<head>
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"
        integrity="sha256-xLD7nhI62fcsEZK2/v8LsBcb4lG7dgULkuXoXB/j91c=" crossorigin="anonymous"></script>

    <title>Log in</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- ===== CSS ===== -->
    <link rel="stylesheet" href="styles.css">

    <!-- ===== BOX ICONS ===== -->
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>

    <script>
        $(document).ready(function () {
            document.getElementById("login-in").addEventListener("submit", function (event) {
                event.preventDefault();

                const formData = new FormData(event.target);
                const obj = Object.fromEntries(formData.entries());
                console.log(JSON.stringify(obj));
                $.ajax({
                    contentType: "application/json",
                    data: JSON.stringify(obj),
                    success: function (data) {
                        sessionStorage.setItem('accessToken', data.accessToken);
                        sessionStorage.setItem('email', data.username);
                        sessionStorage.setItem('name', data.name);
                        window.location.assign('../homepage/homepage.html',);
                    },
                    error: function (xhr) {
                        if (xhr.status === 403) {
                            alert("帳號密碼錯誤！");
                        }
                    },
                    type: "POST",
                    url: "/auth/login"
                });
            });
            updateOptions("../file/department.json");
            $('#identity').change(function () {
                let identity = $(this).val();
                let dataUrl = '';
                if (identity === '學生' || identity === '教職員') {
                    dataUrl = "../file/department.json";
                } else if (identity === '行政人員') {
                    dataUrl = "../file/office.json";
                }
                updateOptions(dataUrl);
            });

            document.getElementById("login-up").addEventListener("submit", function (event) {
                event.preventDefault();
                const formData = new FormData(event.target);
                const password = formData.get("password");
                const confirmPassword = formData.get("confirmPassword");
                if (password !== confirmPassword) {
                    alert("密碼不匹配！");
                    return;
                }
                const filteredData = {
                    name: formData.get("name"),
                    email: formData.get("email"),
                    password: formData.get("password")
                };
                console.log(JSON.stringify(filteredData));
                $.ajax({
                    contentType: "application/json",
                    data: JSON.stringify(filteredData),
                    success: function () {
                        console.log("成功：" + JSON.stringify(filteredData));
                        alert("註冊成功");
                        location.reload();
                    },
                    error: function (xhr) {
                        if (xhr.status === 403) {
                            alert("錯誤：信箱已被使用！");
                        }
                    },
                    type: "POST",
                    url: "/users"
                });
            });
        });
        function updateOptions(dataUrl) {
            $.getJSON(dataUrl, function (data) {
                let selectElement = document.getElementById("organization");
                selectElement.innerHTML = '';
                for (let category in data) {
                    if (data.hasOwnProperty(category)) {
                        data[category].forEach(function (unit) {
                            let option = document.createElement("option");
                            option.value = unit;
                            option.text = unit;
                            selectElement.appendChild(option);
                        });
                    }
                }
            });
        }
    </script>
</head>

<body>
    <div class="login">
        <div class="login__content">
            <div class="login__img">
                <img src="img-login.svg" alt="">
            </div>

            <div class="login__forms">
                <form action="" class="login__registre" id="login-in">
                    <h1 class="login__title">Sign In</h1>

                    <div class="login__box">
                        <i class='bx bx-user login__icon'></i>
                        <input type="email" placeholder="Username" name="username" class="login__input" required>
                    </div>

                    <div class="login__box">
                        <i class='bx bx-lock-alt login__icon'></i>
                        <input type="password" placeholder="Password" name="password" class="login__input" required>
                    </div>

                    <a href="../homepage/homepage.html" class="login__forgot">back to homepage</a>

                    <button type="submit" class="login__button" style="text-decoration: none;">Sign In</button>

                    <div>
                        <span class="login__account">Don't have an Account ?</span>
                        <span class="login__signin" id="sign-up">Sign Up</span>
                    </div>
                </form>

                <form action="" class="login__create none" id="login-up">
                    <h1 class="login__title">Create Account</h1>
                    <select id="identity" name="identity" class="login__select">
                        <option value="學生">學生</option>
                        <option value="教職員">教職員</option>
                        <option value="行政人員">行政人員</option>
                    </select>
                    <!--選擇單位-->
                    <div>
                        <select name="organization" id="organization" class="login__select">
                        </select>
                    </div>
                    <div class="login__box">
                        <i class='bx bx-user login__icon'></i>
                        <input type="text" placeholder="name" name="name" class="login__input" required>
                    </div>
                    <div class="login__box">
                        <i class='bx bx-lock-alt login__icon'></i>
                        <input type="password" placeholder="Password" name="password" class="login__input" required>
                    </div>
                    <div class="login__box">
                        <i class='bx bx-lock-alt login__icon'></i>
                        <input type="password" placeholder="CheckPassword" name="confirmPassword" class="login__input"
                            required>
                    </div>
                    <div class="login__box">
                        <i class='bx bx-at login__icon'></i>
                        <input type="email" placeholder="School Email" name="email" class="login__input" required>
                    </div>

                    <button type="submit" class="login__button">Sign Up</button>

                    <div>
                        <span class="login__account">Already have an Account ?</span>
                        <span class="login__signup" id="sign-in">Sign In</span>
                    </div>


                </form>
            </div>
        </div>
    </div>

    <!--===== MAIN JS =====-->
    <script src="main.js"></script>
</body>

</html>